<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Our Story Mosaic</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/openseadragon.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; background: #0b0b0f; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 28px 16px 16px; }
    .title { color: #e9e9ee; font-size: 28px; letter-spacing: 0.3px; font-weight: 300; text-align: center; }
    .subtitle { color: #bdbdcc; font-size: 16px; text-align: center; margin-top: 10px; }

    #viewer{
      margin: 22px auto 0;
      width: 100%;
      height: 78vh;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 30px 70px rgba(0,0,0,0.65);
      background: #0b0b0f;
    }

    /* Dot marker (only visual) */
    .hotspot-dot{
      width: 18px; height: 18px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.26);
      box-shadow: 0 10px 22px rgba(0,0,0,0.45);
      backdrop-filter: blur(6px);
      opacity: 0;
      transition: opacity .18s ease, transform .18s ease, background .18s ease;
      pointer-events: none; /* IMPORTANT: no hover behavior */
      position: relative;
    }
    #viewer:hover .hotspot-dot{ opacity: 1; }

    .hotspot-dot::after{
      content:"";
      position:absolute;
      inset:-8px;
      border-radius:999px;
      border: 1px solid rgba(255,255,255,0.20);
      opacity: 0;
      transform: scale(0.92);
      transition: opacity .18s ease, transform .18s ease;
    }
    .hotspot-dot.is-active{
      transform: scale(1.14);
      background: rgba(255,255,255,0.14);
    }
    .hotspot-dot.is-active::after{ opacity: 1; transform: scale(1); }

    /* Floating Netflix card (ONE card total) */
    .float-card{
      position: absolute;
      width: min(440px, 80vw);
      padding: 14px 14px 12px;
      border-radius: 16px;
      background: rgba(18,18,24,0.94);
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 24px 70px rgba(0,0,0,0.72);
      color: #f2f2f7;
      backdrop-filter: blur(14px);
      opacity: 0;
      pointer-events: none;
      transition: opacity .14s ease, transform .14s ease;
      transform: translate(-50%, -110%) translateY(10px);
    }
    .float-card.show{
      opacity: 1;
      transform: translate(-50%, -110%) translateY(0);
    }
    .float-card::after{
      content:"";
      position: absolute;
      left: 50%;
      bottom: -7px;
      width: 14px; height: 14px;
      background: rgba(18,18,24,0.94);
      border-right: 1px solid rgba(255,255,255,0.14);
      border-bottom: 1px solid rgba(255,255,255,0.14);
      transform: translateX(-50%) rotate(45deg);
      border-radius: 2px;
    }
    .fc-header{
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
    }
    .fc-title{
      font-size: 14px;
      font-weight: 750;
      letter-spacing: 0.2px;
      margin: 0;
    }
    .fc-tag{
      display: inline-flex;
      align-items: center;
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.88);
      white-space: nowrap;
    }
    .fc-meta{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(255,255,255,0.72);
      line-height: 1.4;
    }
    .fc-meta b{ color: rgba(255,255,255,0.92); font-weight: 650; }
    .fc-body{
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.10);
      font-size: 13px;
      color: rgba(255,255,255,0.86);
      line-height: 1.55;
      white-space: pre-wrap;
      max-height: 220px;
      overflow: auto;
    }

    /* Picker overlay */
    #pickerBar{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      z-index: 999999;
      display: flex;
      gap: 10px;
      align-items: center;
      background: rgba(15,15,20,0.82);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 999px;
      padding: 10px 12px;
      backdrop-filter: blur(10px);
    }
    #pickerBar button{
      background: rgba(255,255,255,0.08);
      color: #e9e9ee;
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 999px;
      padding: 10px 14px;
      cursor: pointer;
      font-size: 13px;
    }
    #copyBtn{ opacity: 0.6; }
    #pickStatus{ color:#b8b8c6; font-size:12px; white-space:nowrap; }

    #pickOutput{
      position: fixed;
      left: 50%;
      bottom: 72px;
      transform: translateX(-50%);
      z-index: 999999;
      width: min(980px, 94vw);
      height: 160px;
      background: rgba(12,12,16,0.92);
      color:#e9e9ee;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 12px;
      font-size: 12px;
      line-height: 1.4;
      display: none;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">Every moment we lived… still lives here.</div>
    <div class="subtitle">Hover directly on a tile region to reveal its note.</div>
    <div id="viewer"></div>
  </div>

  <!-- Picker UI -->
  <div id="pickerBar">
    <button id="pickBtn">Hotspot Picker: OFF</button>
    <button id="copyBtn" disabled>Copy last</button>
    <span id="pickStatus">Click OFF to turn ON</span>
  </div>
  <textarea id="pickOutput" readonly></textarea>

  <script>
    const BASE = "https://fridayflash-ux.github.io/Our-Story";
    const iiifInfo = BASE + "/info.json";

    const memories = [
      {
        id: "m1770596922548",
        rect: { x: 2155, y: 760, w: 220, h: 220 },
        title: "Grace in Every Thread",
        date: "06 Feb 2026",
        location: "City, Place",
        tag: "Stillness",
        extra: "Weather • Mood • People • Anything",
        summary: `She is a fashion diva not because of what she wears,
but because of how she wears it.

Every look she creates tells a story of culture and confidence.
Beauty appears through her thoughtful choices.

Anannya does not follow fashion.
She elevates it.`
      }
    ];

    const viewer = OpenSeadragon({
      id: "viewer",
      prefixUrl: "https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/images/",
      showNavigator: true,
      navigatorPosition: "BOTTOM_RIGHT",
      showFullPageControl: true,
      showHomeControl: true,
      showZoomControl: true,
      zoomPerScroll: 1.2,
      animationTime: 0.8,
      constrainDuringPan: true,
      maxZoomPixelRatio: 2,
      gestureSettingsMouse: {
        clickToZoom: false,
        dblClickToZoom: true,
        dragToPan: true
      }
    });

    // one floating card overlay
    let floatCardEl = null;
    let floatCardVisible = false;
    let activeMemoryId = null;
    const dotEls = new Map(); // id -> dot element

    fetch(iiifInfo)
      .then(r => {
        if (!r.ok) throw new Error("info.json not reachable: " + r.status);
        return r.json();
      })
      .then(info => {
        info["@id"] = BASE;
        info["id"] = BASE;

        viewer.open(info);

        viewer.addOnceHandler("open", () => {
          addDots();
          createFloatingCard();
          initPicker();
          enableTileHover();
        });
      })
      .catch(err => {
        console.error(err);
        alert(err.message);
      });

    function addDots(){
      memories.forEach(m => {
        const cx = m.rect.x + (m.rect.w / 2);
        const cy = m.rect.y + (m.rect.h / 2);
        const vpPoint = viewer.viewport.imageToViewportCoordinates(cx, cy);

        const dot = document.createElement("div");
        dot.className = "hotspot-dot";
        dotEls.set(m.id, dot);

        viewer.addOverlay({
          element: dot,
          location: vpPoint,
          placement: OpenSeadragon.Placement.CENTER,
          checkResize: false
        });
      });
    }

    function createFloatingCard(){
      floatCardEl = document.createElement("div");
      floatCardEl.className = "float-card";
      floatCardEl.style.left = "-9999px";
      floatCardEl.style.top = "-9999px";
      viewer.addOverlay({
        element: floatCardEl,
        location: new OpenSeadragon.Point(0,0),
        placement: OpenSeadragon.Placement.TOP,
        checkResize: false
      });
    }

    function showFloatingCardForMemory(m){
      // update content only if changed
      if (activeMemoryId !== m.id){
        floatCardEl.innerHTML = `
          <div class="fc-header">
            <div>
              <div class="fc-title">${escapeHtml(m.title || "Memory")}</div>
              <div class="fc-meta">
                <b>Date:</b> ${escapeHtml(m.date || "—")}<br>
                <b>Location:</b> ${escapeHtml(m.location || "—")}<br>
                <b>Extras:</b> ${escapeHtml(m.extra || "—")}
              </div>
            </div>
            ${m.tag ? `<div class="fc-tag">${escapeHtml(m.tag)}</div>` : ""}
          </div>
          <div class="fc-body">${escapeHtml(m.summary || "")}</div>
        `;
        activeMemoryId = m.id;
      }

      // position the card above center of tile
      const cx = m.rect.x + (m.rect.w / 2);
      const cy = m.rect.y + (m.rect.h / 2);

      const vpPoint = viewer.viewport.imageToViewportCoordinates(cx, cy);
      viewer.updateOverlay(floatCardEl, vpPoint, OpenSeadragon.Placement.TOP);

      // show
      if (!floatCardVisible){
        floatCardEl.classList.add("show");
        floatCardVisible = true;
      }

      // activate dot visual
      dotEls.forEach((el, id) => el.classList.toggle("is-active", id === m.id));
    }

    function hideFloatingCard(){
      if (floatCardVisible){
        floatCardEl.classList.remove("show");
        floatCardVisible = false;
      }
      activeMemoryId = null;
      dotEls.forEach(el => el.classList.remove("is-active"));
    }

    // Exact hover within tile rects (pixel perfect)
    function enableTileHover(){
      const canvasEl = viewer.canvas; // OSD canvas element

      // small debounce to avoid flicker
      let rafPending = false;
      let lastEvent = null;

      canvasEl.addEventListener("mousemove", (e) => {
        if (window.__PICK_MODE__) return; // don't fight picker
        lastEvent = e;
        if (rafPending) return;
        rafPending = true;
        requestAnimationFrame(() => {
          rafPending = false;
          handleHover(lastEvent);
        });
      });

      canvasEl.addEventListener("mouseleave", () => {
        if (window.__PICK_MODE__) return;
        hideFloatingCard();
      });
    }

    function handleHover(e){
      const rect = viewer.element.getBoundingClientRect();
      const webPoint = new OpenSeadragon.Point(e.clientX - rect.left, e.clientY - rect.top);

      const viewportPoint = viewer.viewport.pointFromPixel(webPoint);
      const imagePoint = viewer.viewport.viewportToImageCoordinates(viewportPoint);

      // find memory whose rect contains mouse
      const hit = memories.find(m =>
        imagePoint.x >= m.rect.x &&
        imagePoint.x <= (m.rect.x + m.rect.w) &&
        imagePoint.y >= m.rect.y &&
        imagePoint.y <= (m.rect.y + m.rect.h)
      );

      if (!hit){
        hideFloatingCard();
        return;
      }
      showFloatingCardForMemory(hit);
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // Picker: click mosaic to generate a memory block
    function initPicker(){
      window.__PICK_MODE__ = false;
      let pickSize = 220;
      let lastBlock = "";

      const btn = document.getElementById("pickBtn");
      const copyBtn = document.getElementById("copyBtn");
      const status = document.getElementById("pickStatus");
      const out = document.getElementById("pickOutput");

      function setUI(){
        btn.textContent = window.__PICK_MODE__ ? "Hotspot Picker: ON" : "Hotspot Picker: OFF";
        status.textContent = window.__PICK_MODE__ ? "Picker ON ✅ Click the mosaic" : "Click OFF to turn ON";
        if (!window.__PICK_MODE__) out.style.display = out.value ? "block" : "none";
      }
      setUI();

      btn.addEventListener("click", () => {
        window.__PICK_MODE__ = !window.__PICK_MODE__;
        setUI();
        if (window.__PICK_MODE__) hideFloatingCard();
      });

      copyBtn.addEventListener("click", async () => {
        if (!lastBlock) return;
        try{
          await navigator.clipboard.writeText(lastBlock);
          status.textContent = "Copied ✅ Paste into memories[]";
        }catch{
          status.textContent = "Clipboard blocked. Select text and Ctrl+C.";
          out.focus(); out.select();
        }
      });

      viewer.addHandler("canvas-click", (event) => {
        if (!window.__PICK_MODE__) return;

        const webPoint = event.position;
        const viewportPoint = viewer.viewport.pointFromPixel(webPoint);
        const imagePoint = viewer.viewport.viewportToImageCoordinates(viewportPoint);

        const x = Math.max(0, Math.round(imagePoint.x - pickSize / 2));
        const y = Math.max(0, Math.round(imagePoint.y - pickSize / 2));
        const w = pickSize;
        const h = pickSize;

        lastBlock =
`{
  id: "m${Date.now()}",
  rect: { x: ${x}, y: ${y}, w: ${w}, h: ${h} },
  title: "Title here",
  date: "DD MMM YYYY",
  location: "City, Place",
  tag: "Stillness",
  extra: "Weather • Mood • People • Anything",
  summary: \`Line 1
Line 2
Line 3
Line 4
Line 5
Line 6
Line 7
Line 8
Line 9
Line 10\`
},`;

        out.value = lastBlock;
        out.style.display = "block";
        copyBtn.disabled = false;
        copyBtn.style.opacity = "1";
        status.textContent = `Captured ✅ x=${x}, y=${y} (${w}×${h})`;

        event.preventDefaultAction = true;
      });
    }
  </script>
</body>
</html>
